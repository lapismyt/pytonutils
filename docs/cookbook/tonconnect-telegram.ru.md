## Введение

Это руководство демонстрирует, как интегрировать TON Connect в Telegram-бота с использованием библиотеки `tonutils` — Python SDK для взаимодействия с TON.

Функциональность бота включает:

- Подключение кошелька через QR-код или ссылку
- Подписание произвольных данных
- Отправку транзакций

Реализация спроектирована с учётом продакшн-практик: надёжное хранение сессий, асинхронная архитектура, защита от спама, минималистичный пользовательский интерфейс на inline-кнопках.

!!! tip
    Перед началом рекомендуется ознакомиться с документацией [Рецепты: Интеграция TON Connect](tonconnect-integration.md)

## Подготовка

Перед началом работы выполните следующие шаги.

### Создание Telegram-бота

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram.
2. Введите команду `/newbot` и следуйте инструкциям.
3. Сохраните токен бота.

### Создание манифеста TonConnect

Создайте JSON-файл, описывающий ваше приложение. Этот манифест будет отображаться в кошельке при подключении.

  ```json
  {
    "url": "<app-url>",                        // required
    "name": "<app-name>",                      // required
    "iconUrl": "<app-icon-url>",               // required
    "termsOfUseUrl": "<terms-of-use-url>",     // optional
    "privacyPolicyUrl": "<privacy-policy-url>" // optional
  }
  ```

!!! note
    Убедитесь, что файл доступен по-указанному URL.

Подробная спецификация доступна в официальной [документации по манифесту](https://docs.ton.org/v3/guidelines/ton-connect/guidelines/creating-manifest).

## Установка зависимостей

Создайте файл `requirements.txt` со следующим содержимым:

```
--8<-- "examples/tonconnect/telegram_bot/requirements.txt"
```

Установите все зависимости с помощью команды:

```bash
pip install -r requirements.txt
```

## Конфигурация окружения

Создайте файл `.env` в корне проекта и укажите следующие переменные:

```env
BOT_TOKEN=ваш_токен_бота
REDIS_DSN=redis://localhost:6379/0
TC_MANIFEST=https://ваш-домен/manifest.json
```

Описание переменных:

* `BOT_TOKEN` — токен Telegram-бота, полученный через [@BotFather](https://t.me/BotFather).
* `REDIS_DSN` — строка подключения к Redis, для хранения сессий и состояний.
* `TC_MANIFEST` — HTTPS-ссылка на публично доступный манифест TON Connect.

## Структура проекта

```
├── .env
├── requirements.txt
└── src/
    ├── utils/
    │   ├── __init__.py
    │   ├── keyboards.py
    │   ├── models.py
    │   ├── storage.py
    │   └── windows.py
    ├── __init__.py
    ├── __main__.py
    ├── events.py
    ├── handlers.py
    ├── middlewares.py
    └── session_manager.py
```

## Реализация

Раздел состоит из отдельных модулей, каждый из которых отвечает за конкретную часть логики. Далее рассмотрим их по порядку.

### Конфигурация

**Файл:** `src/utils/models.py`

Модуль отвечает за:

- Загрузку конфигурационных переменных из `.env` файла.
- Формирование объекта `Context`, содержащего основные зависимости.

#### Состав `Context`

- `bot: Bot` — экземпляр Telegram-бота (`aiogram`).
- `state: FSMContext` — контекст состояний пользователя.
- `tc: TonConnect` — основной объект для работы с TON Connect.
- `connector: Connector` — сессия, инициализированная для конкретного ID.

#### Использование

- При запуске вызывается `Config.load()` — он загружает настройки из `.env`.
- В middleware создаётся объект `Context`, который передаётся во все обработчики, предоставляя доступ к нужным зависимостям.

<details>
<summary>Пример кода</summary>

```python
--8<-- "examples/tonconnect/telegram_bot/src/utils/models.py"
```

</details>

### Хранение сессий

**Файл:** `src/utils/storage.py`

В веб-версии TON Connect сессии кошельков сохраняются в `localStorage`. Однако в серверной среде на Python необходимо реализовать собственную систему хранения.

В этом проекте используется Redis: данные сессий сохраняются с привязкой к Telegram ID пользователя.

#### Задачи модуля

- Сохранять данные TON Connect по Telegram ID.
- Извлекать данные сессии при подключении пользователя.
- Удалять сессии при отключении или очистке.

Такая реализация обеспечивает надёжное восстановление пользовательского состояния между сессиями.

<details>
<summary>Пример кода</summary>

```python
--8<-- "examples/tonconnect/telegram_bot/src/utils/storage.py"
```

</details>

### Очистка сообщений

**Файл:** `src/utils/__init__.py`

Модуль отвечает за автоматическое удаление предыдущего сообщения пользователя перед отправкой нового. Это предотвращает накопление сообщений и обеспечивает чистый, лаконичный интерфейс.

#### Принцип работы

- В FSM-состоянии пользователя хранится `message_id` последнего сообщения от бота.
- Перед отправкой нового бот пытается удалить старое сообщение.
- После отправки нового сохраняется его `message_id` для последующей очистки.

Это особенно полезно для ботов с динамическим UI (inline-кнопки, обновляемые окна).

<details>
<summary>Пример кода</summary>

```python
--8<-- "examples/tonconnect/telegram_bot/src/utils/__init__.py"
```

</details>

### Клавиатуры

**Файл:** `src/utils/keyboards.py`

Модуль формирует inline-клавиатуры для взаимодействия пользователя с ботом. Он обеспечивает удобную навигацию и быстрое выполнение действий.

#### Основные типы клавиатур

- **Подключение кошелька** — список доступных кошельков с кнопками подключения.
- **Подтверждение запроса** — кнопки для открытия кошелька или отмены запроса.
- **Главное меню** — отправка транзакции, пакетная отправка, подписание данных, отключение.
- **Выбор формата подписи** — текст, бинарный или ячейка.
- **Возврат в меню** — кнопка возвращения на главный экран.

Клавиатуры адаптированы под разные сценарии использования и обновляются в зависимости от состояния пользователя.

<details>
<summary>Пример кода</summary>

```python
--8<-- "examples/tonconnect/telegram_bot/src/utils/keyboards.py"
```

</details>

### Интерфейсные окна

**Файл:** `src/utils/windows.py`

Модуль управляет отображением сообщений и inline-клавиатур в Telegram-чате. Он реализует интерфейсные "экраны" — логически завершённые состояния взаимодействия с пользователем.

#### Основные функции

- **Экран подключения кошелька** — отображает список кошельков, генерирует `ton_proof`, создаёт ссылку подключения и QR-код.
- **Главное меню** — показывает адрес подключённого кошелька и действия: отправка, подпись, отключение.
- **Подтверждение запросов** — предлагает пользователю подтвердить действие в приложении-кошельке.
- **Результаты операций** — отображает хеши транзакций, результаты подписей и их проверку.
- **Обработка ошибок** — сообщает об ошибках и предлагает повторить попытку или вернуться в меню.

<details>
<summary>Пример кода</summary>

```python
--8<-- "examples/tonconnect/telegram_bot/src/utils/windows.py"
```

</details>

### Очистка сессий

**Файл:** `src/session_manager.py`

Модуль реализует фоновую задачу, которая отслеживает активность пользователей и приостанавливает неактивные SSE-соединения TON Connect, снижая нагрузку.

#### Основные механизмы

- Метки времени последней активности пользователей сохраняются в Redis с использованием отсортированного множества (`ZSET`).
- С определённым интервалом происходит обход пользователей, неактивных дольше установленного времени (`session_lifetime`).
- Для неактивных вызывается метод `pause_sse()` на их коннекторе, что освобождает ресурсы.
- После успешной приостановки запись о пользователе удаляется из Redis.

#### Параметры настройки

- `session_lifetime` — максимальная длительность не активности, по умолчанию 1 час.
- `check_interval` — периодичность проверки, по умолчанию 10 минут.
- `redis_key` — ключ Redis, используемый для хранения временных меток активности.

Этот механизм полезен в продакшн-среде, где открытые соединения имеют стоимость и должны быть контролируемыми.

<details>
<summary>Пример кода</summary>

```python
--8<-- "examples/tonconnect/telegram_bot/src/session_manager.py"
```

</details>

### Промежуточные слои

**Файл:** `src/middlewares.py`

Модуль реализует два ключевых промежуточных слоя (`middleware`) для Telegram-бота:

#### ContextMiddleware

- Создаёт объект `Context` при каждом входящем обновлении.
- Также обновляет метку активности пользователя — это позволяет корректно отслеживать и закрывать неактивные соединения.

#### ThrottlingMiddleware

- Минимальная защита от спама.
- Использует TTL-кеш, ограничивая частоту запросов от одного пользователя.

<details>
<summary>Пример кода</summary>

```python
--8<-- "examples/tonconnect/telegram_bot/src/middlewares.py"
```

</details>
### Обработка событий

**Файл:** `src/events.py`

Модуль отвечает за регистрацию и обработку событий TON Connect, а также обработку связанных с ними ошибок.

#### Основные события

- **Подключение кошелька (`CONNECT`)**
    - Проверяет корректность `ton_proof`.
    - При успешной верификации отображает главное меню.
    - При ошибке — отключает сессию и предлагает повторное подключение.

- **Ошибки подключения**
    - Обрабатываются случаи отклонения пользователем или таймаута.
    - Пользователю отправляется уведомление и предложена повторная попытка.

- **Отключение (`DISCONNECT`)**
    - Обрабатывает как явное отключение, так и вынужденное (например, при недействительном `proof`).
    - Предлагается повторное подключение.

- **Ошибки отключения**
    - Уведомляют пользователя об ошибке и не прерывают основной сценарий.

- **Отправка транзакции (`TRANSACTION`)**
    - Показывает хеш транзакции при успехе.
    - В случае ошибки — объяснение и выбор: повторить или вернуться в меню.

- **Подпись данных (`SIGN_DATA`)**
    - Показывает результат подписи и её проверку.
    - Обрабатывает ошибки и уведомляет пользователя.

Все события регистрируются через метод `register_event` у экземпляра `TonConnect`.

<details>
<summary>Пример кода</summary>

```python
--8<-- "examples/tonconnect/telegram_bot/src/events.py"
```

</details>

### Обработчики Telegram

**Файл:** `src/handlers.py`

Модуль содержит Telegram-хендлеры, отвечающие за взаимодействие пользователя с ботом через команды и inline-кнопки.

#### Основные задачи

- **Обработка команды `/start`**
    - Если кошелёк ещё не подключён — запускает окно выбора и подключения кошелька.
    - Если уже подключён — открывает главное меню с действиями.

- **Обработка inline callback’ов**
    - Выбор кошелька и инициализация подключения.
    - Навигация по меню: главное меню, подключение, отключение.
    - Отмена активных запросов: транзакций и подписей.
    - Отправка одиночной транзакции.
    - Отправка batch-транзакции.
    - Запрос подписи данных.

<details>
<summary>Пример кода</summary>

```python
--8<-- "examples/tonconnect/telegram_bot/src/handlers.py"
```

</details>

### Точка входа

**Файл:** `src/__main__.py`

Этот модуль является финальной сборочной точкой, связывающей все компоненты системы.

#### Основные задачи

- Загружает конфигурацию из `.env` с помощью `Config.load()`.
- Создаёт подключения к Redis:
    - для хранения FSM-состояний,
    - для хранения сессий TonConnect.
- Инициализирует объекты `Bot`, `TonConnect`, `Dispatcher`.
- Регистрирует:
    - хендлеры Telegram-команд и inline-кнопок,
    - подписки на события TonConnect,
    - промежуточные слои.
- Запускает `TonConnectSessionManager` — фоновую задачу очистки неактивных сессий.
- Запускает polling — цикл обработки входящих Telegram-обновлений.

<details>
<summary>Пример кода</summary>

```python
--8<-- "examples/tonconnect/telegram_bot/src/__main__.py"
```

</details>

### Запуск бота

* Убедитесь, что в корне проекта находится файл `.env` с необходимыми переменными окружения.
* Убедитесь, что сервер Redis запущен и доступен по адресу, указанному в `REDIS_DSN`.
* Запустите бота командой:

    ```bash
    python -m src
    ```

## Заключение

Этот бот представляет собой надёжную и расширяемую основу для интеграции TON Connect в Telegram. Он реализует ключевые возможности подключения кошельков, отправки транзакций и подписи данных, а также обеспечивает устойчивое хранение сессий и экономию ресурсов за счёт управления SSE-соединениями.
Архитектура проекта модульная и легко адаптируется под задачи конкретного приложения.

Полный исходный код доступен по ссылке: [tonconnect-demo-bot](https://github.com/nessshon/tonutils/blob/main/examples/tonconnect/telegram_bot)

## См. Также

* [Документация и спецификации TON Connect](https://github.com/ton-blockchain/ton-connect)
* [Документация tonutils TON Connect](https://nessshon.github.io/tonutils/cookbook/tonconnect-integration/)
* [Документация aiogram](https://docs.aiogram.dev/)
